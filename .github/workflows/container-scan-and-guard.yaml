name: Container Scan and Guard

# Shareable workflow for Container Image Security Scanning
# Runs FOSSA container scan with licensing and vulnerability checks
# Supports both PR (diff-based) and Release (full scan) contexts

on:
  workflow_call:
    inputs:
      container_image:
        description: 'Container image to scan (registry/repository:tag format). Required.'
        required: true
        type: string
      skip_fossa_gate:
        description: 'EMERGENCY: Skip FOSSA gate (for outages or critical issues)'
        required: false
        type: boolean
        default: false
      bypass_justification:
        description: 'REQUIRED: Justification for bypassing FOSSA gate'
        required: false
        type: string
        default: ''
      slack_channel:
        description: 'Slack channel for failure notifications'
        required: false
        type: string
        default: '#sc-deploy-cicd-activity'
      fossa_licensing_mode:
        description: 'FOSSA licensing check mode: BLOCK (fail on violations) or REPORT (report only)'
        required: false
        type: string
        default: 'REPORT'
      fossa_licensing_block_on:
        description: 'What to block on for licensing: policy_conflict, policy_flag, etc.'
        required: false
        type: string
        default: 'policy_conflict'
      fossa_vulnerability_mode:
        description: 'FOSSA vulnerability check mode: BLOCK (fail on vulnerabilities) or REPORT (report only)'
        required: false
        type: string
        default: 'REPORT'
      fossa_vulnerability_block_on:
        description: 'Vulnerability severities to block on (comma-separated): critical,high,medium,low'
        required: false
        type: string
        default: 'critical,high'
      use_vault:
        description: 'Retrieve FOSSA API key from Vault (for private repos). If false, expects FOSSA_API_KEY from secrets.'
        required: false
        type: boolean
        default: false
      vault_url:
        description: 'Vault URL (required if use_vault is true)'
        required: false
        type: string
        default: ''
      vault_role:
        description: 'Vault role for JWT authentication'
        required: false
        type: string
        default: 'cicd-workflows-secret-read-role'
      vault_secret_path:
        description: 'Vault secret path for FOSSA API key'
        required: false
        type: string
        default: 'secret/data/tools/githubactions'
      fossa_project_override:
        description: 'Override FOSSA project ID (default: repository_owner_repository_name)'
        required: false
        type: string
        default: ''
      additional_scan_params:
        description: |
          Additional scanner-specific parameters (one per line):
            fossa.debug=true
            fossa.team=Platform Team
        required: false
        type: string
        default: ''
      config_file:
        description: 'Path to workflow configuration file (overrides individual inputs if provided)'
        required: false
        type: string
        default: ''
      skip_policy_gate:
        description: 'EMERGENCY: Skip policy/licensing gate (requires admin)'
        required: false
        type: boolean
        default: false
      skip_vulnerability_gate:
        description: 'EMERGENCY: Skip vulnerability gate (requires admin)'
        required: false
        type: boolean
        default: false

    secrets:
      FOSSA_API_KEY:
        description: 'FOSSA API key (required if use_vault is false)'
        required: false
      VAULT_ROLE:
        description: 'Vault role for JWT authentication (passed as secret)'
        required: false
      VAULT_AWS_ROLE:
        description: 'Vault AWS STS role path for ECR authentication'
        required: false
      AWS_ACCESS_KEY_ID:
        description: 'AWS Access Key ID for ECR authentication (required if use_vault is false and scanning ECR images)'
        required: false
      AWS_SECRET_ACCESS_KEY:
        description: 'AWS Secret Access Key for ECR authentication (required if use_vault is false and scanning ECR images)'
        required: false

permissions:
  contents: read
  pull-requests: write
  id-token: write
  checks: write

jobs:
  container_scan:
    name: 'Container Scan'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Workflow Configuration
        if: inputs.config_file != ''
        id: config_loader
        uses: SolaceDev/solace-public-workflows/workflow-config-loader@feature/container-scan-action
        with:
          config_file: ${{ inputs.config_file }}
          config_type: container_scanning
      - name: Check Admin Permissions for Bypass
        if: inputs.skip_fossa_gate == true
        uses: actions/github-script@v7
        with:
          script: |
            const actor = context.actor;
            const repo = context.repo;

            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: repo.owner,
                repo: repo.repo,
                username: actor
              });

              console.log(`User ${actor} has permission: ${permission.permission}`);

              if (permission.permission !== 'admin') {
                core.setFailed(`‚ùå FOSSA bypass denied: User ${actor} does not have admin permissions. Only repository admins can bypass FOSSA gate.`);
              } else {
                console.log(`‚úÖ Admin permission verified for ${actor}`);
              }
            } catch (error) {
              core.setFailed(`Failed to check permissions: ${error.message}`);
            }

      - name: Validate Container Image Input
        run: |
          if [[ -z "${{ inputs.container_image }}" ]]; then
            echo "‚ùå Error: container_image input is required"
            exit 1
          fi
          echo "‚úÖ Container image: ${{ inputs.container_image }}"

      - name: Merge Configuration and Inputs
        id: config
        run: |
          # Use config values if config_file was provided, otherwise use inputs
          if [[ -n "${{ inputs.config_file }}" ]]; then
            echo "üìù Using configuration from file: ${{ inputs.config_file }}"
            echo "vault_url=${{ steps.config_loader.outputs.vault_url }}" >> $GITHUB_OUTPUT
            echo "vault_secret_path=${{ steps.config_loader.outputs.vault_secret_path }}" >> $GITHUB_OUTPUT
            echo "vault_aws_role=${{ steps.config_loader.outputs.vault_aws_role }}" >> $GITHUB_OUTPUT
            echo "slack_channel=${{ steps.config_loader.outputs.slack_channel }}" >> $GITHUB_OUTPUT
            echo "fossa_licensing_mode=${{ steps.config_loader.outputs.fossa_licensing_mode }}" >> $GITHUB_OUTPUT
            echo "fossa_licensing_block_on=${{ steps.config_loader.outputs.fossa_licensing_block_on }}" >> $GITHUB_OUTPUT
            echo "fossa_vulnerability_mode=${{ steps.config_loader.outputs.fossa_vulnerability_mode }}" >> $GITHUB_OUTPUT
            echo "fossa_vulnerability_block_on=${{ steps.config_loader.outputs.fossa_vulnerability_block_on }}" >> $GITHUB_OUTPUT
            echo "fossa_project_override=${{ steps.config_loader.outputs.fossa_project_id }}" >> $GITHUB_OUTPUT
          else
            echo "üìù Using configuration from workflow inputs"
            echo "vault_url=${{ inputs.vault_url }}" >> $GITHUB_OUTPUT
            echo "vault_secret_path=${{ inputs.vault_secret_path }}" >> $GITHUB_OUTPUT
            echo "vault_aws_role=" >> $GITHUB_OUTPUT
            echo "slack_channel=${{ inputs.slack_channel }}" >> $GITHUB_OUTPUT
            echo "fossa_licensing_mode=${{ inputs.fossa_licensing_mode }}" >> $GITHUB_OUTPUT
            echo "fossa_licensing_block_on=${{ inputs.fossa_licensing_block_on }}" >> $GITHUB_OUTPUT
            echo "fossa_vulnerability_mode=${{ inputs.fossa_vulnerability_mode }}" >> $GITHUB_OUTPUT
            echo "fossa_vulnerability_block_on=${{ inputs.fossa_vulnerability_block_on }}" >> $GITHUB_OUTPUT
            echo "fossa_project_override=${{ inputs.fossa_project_override }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine scan context
        id: context
        run: |
          echo "### üîç Container Scan Context Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract image tag from container_image (use as FOSSA revision)
          CONTAINER_IMAGE="${{ inputs.container_image }}"
          IMAGE_TAG="${CONTAINER_IMAGE##*:}"
          echo "revision=${IMAGE_TAG}" >> $GITHUB_OUTPUT

          # Detect if this is a PR or non-PR scan
          if [[ -n "${{ github.event.pull_request.number }}" ]]; then
            # PR context - diff-based scan
            echo "branch=PR" >> $GITHUB_OUTPUT
            echo "scan_type=PR" >> $GITHUB_OUTPUT
            echo "**Context**: Pull Request #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**Scan Type**: Diff-based (new issues only)" >> $GITHUB_STEP_SUMMARY
            echo "**Branch**: PR" >> $GITHUB_STEP_SUMMARY
          else
            # Non-PR context (push, workflow_dispatch, etc.) - full scan
            echo "branch=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
            echo "scan_type=Full" >> $GITHUB_OUTPUT
            echo "**Context**: Full Scan" >> $GITHUB_STEP_SUMMARY
            echo "**Scan Type**: Full scan (all dependencies)" >> $GITHUB_STEP_SUMMARY
            echo "**Branch**: ${{ github.event.repository.default_branch }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Container Image**: ${CONTAINER_IMAGE}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag (FOSSA Revision)**: ${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY

      - name: Retrieve FOSSA API key from Vault
        id: vault_secrets
        if: inputs.use_vault == true
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ steps.config.outputs.vault_url }}
          role: ${{ inputs.vault_role }}
          method: jwt
          path: jwt-github
          jwtGithubAudience: https://github.com/${{ github.repository_owner }}
          exportToken: true
          secrets: |
            ${{ steps.config.outputs.vault_secret_path }} FOSSA_FULL_API_TOKEN | FOSSA_API_KEY

      - name: Determine Vault AWS Role
        id: vault_aws_role
        if: inputs.use_vault == true
        run: |
          # Use config value first, fallback to secret if config is empty
          if [[ -n "${{ steps.config.outputs.vault_aws_role }}" ]]; then
            echo "aws_role=${{ steps.config.outputs.vault_aws_role }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Using Vault AWS role from config"
          elif [[ -n "${{ secrets.VAULT_AWS_ROLE }}" ]]; then
            echo "aws_role=${{ secrets.VAULT_AWS_ROLE }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Using Vault AWS role from secret"
          else
            echo "‚ö†Ô∏è No Vault AWS role configured - ECR authentication will be skipped"
            echo "aws_role=" >> $GITHUB_OUTPUT
          fi

      - name: Generate AWS Credentials from Vault
        id: aws_creds
        if: inputs.use_vault == true && steps.vault_aws_role.outputs.aws_role != ''
        continue-on-error: true
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ steps.config.outputs.vault_url }}
          role: ${{ inputs.vault_role }}
          method: jwt
          path: jwt-github
          jwtGithubAudience: https://github.com/${{ github.repository_owner }}
          secrets: |
            ${{ steps.vault_aws_role.outputs.aws_role }} access_key | AWS_ACCESS_KEY_ID ;
            ${{ steps.vault_aws_role.outputs.aws_role }} secret_key | AWS_SECRET_ACCESS_KEY ;
            ${{ steps.vault_aws_role.outputs.aws_role }} security_token | AWS_SESSION_TOKEN

      - name: Configure AWS Credentials (Vault)
        if: inputs.use_vault == true && steps.aws_creds.outcome == 'success'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ steps.aws_creds.outputs.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ steps.aws_creds.outputs.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ steps.aws_creds.outputs.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Configure AWS Credentials (GitHub Secrets)
        if: inputs.use_vault == false
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        continue-on-error: true
        uses: aws-actions/amazon-ecr-login@v2

      - name: Validate FOSSA API Key
        id: fossa_key
        shell: bash
        run: |
          if [[ "${{ inputs.use_vault }}" == "true" ]]; then
            # Vault mode - key from Vault
            if [[ -z "${{ steps.vault_secrets.outputs.FOSSA_API_KEY }}" ]]; then
              echo "‚ùå Error: FOSSA_API_KEY not retrieved from Vault"
              exit 1
            fi
            echo "FOSSA_KEY=${{ steps.vault_secrets.outputs.FOSSA_API_KEY }}" >> $GITHUB_OUTPUT
            echo "‚úÖ FOSSA API key retrieved from Vault"
          else
            # GitHub Secrets mode - key from secrets
            if [[ -z "${{ secrets.FOSSA_API_KEY }}" ]]; then
              echo "‚ùå Error: FOSSA_API_KEY secret not provided"
              exit 1
            fi
            echo "FOSSA_KEY=${{ secrets.FOSSA_API_KEY }}" >> $GITHUB_OUTPUT
            echo "‚úÖ FOSSA API key retrieved from GitHub Secrets"
          fi

      - name: Determine FOSSA Project ID
        id: fossa_project
        run: |
          if [[ -n "${{ steps.config.outputs.fossa_project_override }}" ]]; then
            FOSSA_PROJECT_ID="${{ steps.config.outputs.fossa_project_override }}"
            echo "Using override project ID: $FOSSA_PROJECT_ID"
          else
            FOSSA_PROJECT_ID="${{ github.repository_owner }}_${{ github.event.repository.name }}"
            echo "Using default project ID: $FOSSA_PROJECT_ID"
          fi
          echo "FOSSA_PROJECT_ID=${FOSSA_PROJECT_ID}" >> $GITHUB_OUTPUT

      - name: Container Scan - FOSSA
        uses: SolaceDev/solace-public-workflows/container/container-scan@feature/container-scan-action
        with:
          scanners: "fossa"
          additional_scan_params: |
            fossa.image=${{ inputs.container_image }}
            fossa.project=${{ steps.fossa_project.outputs.FOSSA_PROJECT_ID }}
            fossa.branch=${{ steps.context.outputs.branch }}
            fossa.revision=${{ steps.context.outputs.revision }}
            ${{ inputs.additional_scan_params }}
          fossa_api_key: ${{ steps.fossa_key.outputs.FOSSA_KEY }}

      - name: FOSSA Licensing Check
        id: fossa_licensing
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@feature/container-scan-action
        continue-on-error: true
        with:
          fossa_api_key: ${{ steps.fossa_key.outputs.FOSSA_KEY }}
          fossa_project_id: ${{ steps.fossa_project.outputs.FOSSA_PROJECT_ID }}
          fossa_branch: ${{ steps.context.outputs.branch }}
          fossa_revision: ${{ steps.context.outputs.revision }}
          fossa_category: licensing
          fossa_mode: ${{ steps.config.outputs.fossa_licensing_mode }}
          block_on: ${{ steps.config.outputs.fossa_licensing_block_on }}
          enable_diff_mode: ${{ github.event_name == 'pull_request' }}
          enable_pr_comment: ${{ github.event_name == 'pull_request' }}
          enable_status_check: ${{ github.event_name == 'pull_request' }}
          status_check_name: "FOSSA Container Licensing"

      - name: FOSSA Vulnerability Check
        id: fossa_vulnerabilities
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@feature/container-scan-action
        continue-on-error: true
        with:
          fossa_api_key: ${{ steps.fossa_key.outputs.FOSSA_KEY }}
          fossa_project_id: ${{ steps.fossa_project.outputs.FOSSA_PROJECT_ID }}
          fossa_branch: ${{ steps.context.outputs.branch }}
          fossa_revision: ${{ steps.context.outputs.revision }}
          fossa_category: vulnerability
          fossa_mode: ${{ steps.config.outputs.fossa_vulnerability_mode }}
          block_on: ${{ steps.config.outputs.fossa_vulnerability_block_on }}
          enable_diff_mode: ${{ github.event_name == 'pull_request' }}
          enable_pr_comment: ${{ github.event_name == 'pull_request' }}
          enable_status_check: ${{ github.event_name == 'pull_request' }}
          status_check_name: "FOSSA Container Vulnerabilities"

      - name: Report Container Scan Results
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Container Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Licensing Check Results
          if [[ "${{ steps.fossa_licensing.outcome }}" == "success" ]]; then
            echo "‚úÖ **Licensing Check**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "   _Mode: ${{ steps.config.outputs.fossa_licensing_mode }}, Block on: ${{ steps.config.outputs.fossa_licensing_block_on }}_" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.fossa_licensing.outcome }}" == "failure" ]]; then
            if [[ "${{ steps.config.outputs.fossa_licensing_mode }}" == "BLOCK" ]]; then
              echo "‚ùå **Licensing Check**: FAILED (policy conflicts detected) - BLOCKING" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è **Licensing Check**: FAILED (policy conflicts detected) - REPORT ONLY" >> $GITHUB_STEP_SUMMARY
            fi
            echo "   _Mode: ${{ steps.config.outputs.fossa_licensing_mode }}, Block on: ${{ steps.config.outputs.fossa_licensing_block_on }}_" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.skip_fossa_gate }}" == "true" ]]; then
            echo "‚ö†Ô∏è **Licensing Check**: SKIPPED (emergency bypass)" >> $GITHUB_STEP_SUMMARY
            echo "**Justification**: ${{ inputs.bypass_justification }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Licensing Check**: UNKNOWN" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Vulnerability Check Results
          if [[ "${{ steps.fossa_vulnerabilities.outcome }}" == "success" ]]; then
            echo "‚úÖ **Vulnerability Check**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "   _Mode: ${{ steps.config.outputs.fossa_vulnerability_mode }}, Block on: ${{ steps.config.outputs.fossa_vulnerability_block_on }}_" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.fossa_vulnerabilities.outcome }}" == "failure" ]]; then
            if [[ "${{ steps.config.outputs.fossa_vulnerability_mode }}" == "BLOCK" ]]; then
              echo "‚ùå **Vulnerability Check**: FAILED (${{ steps.config.outputs.fossa_vulnerability_block_on }} vulnerabilities detected) - BLOCKING" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è **Vulnerability Check**: ISSUES FOUND (${{ steps.config.outputs.fossa_vulnerability_block_on }} vulnerabilities detected) - REPORT ONLY" >> $GITHUB_STEP_SUMMARY
            fi
            echo "   _Mode: ${{ steps.config.outputs.fossa_vulnerability_mode }}, Block on: ${{ steps.config.outputs.fossa_vulnerability_block_on }}_" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.skip_fossa_gate }}" == "true" ]]; then
            echo "‚ö†Ô∏è **Vulnerability Check**: SKIPPED (emergency bypass)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Vulnerability Check**: UNKNOWN" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Container Image**: ${{ inputs.container_image }}" >> $GITHUB_STEP_SUMMARY
          echo "**FOSSA Project**: ${{ steps.fossa_project.outputs.FOSSA_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ steps.context.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Revision**: ${{ steps.context.outputs.revision }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type**: ${{ steps.context.outputs.scan_type }}" >> $GITHUB_STEP_SUMMARY

          # URL encode the revision for the dashboard link
          ENCODED_REVISION=$(echo "${{ steps.context.outputs.revision }}" | jq -sRr @uri)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard**: [View in FOSSA](https://app.fossa.com/projects/custom%2B1%2F${{ steps.fossa_project.outputs.FOSSA_PROJECT_ID }}/refs/branch/${{ steps.context.outputs.branch }}/${ENCODED_REVISION})" >> $GITHUB_STEP_SUMMARY

      - name: Block on FOSSA Licensing Failures
        if: |
          always() && !inputs.skip_fossa_gate &&
          steps.fossa_licensing.outcome == 'failure'
        run: |
          echo "‚ùå FOSSA licensing check failed. Licensing policy conflicts detected in container image."
          echo "Review the FOSSA dashboard for details and remediate policy violations."
          exit 1

      - name: Block on FOSSA Vulnerability Failures
        if: |
          always() && !inputs.skip_fossa_gate &&
          steps.fossa_vulnerabilities.outcome == 'failure' &&
          steps.config.outputs.fossa_vulnerability_mode == 'BLOCK'
        run: |
          echo "‚ùå FOSSA vulnerability check failed. ${{ steps.config.outputs.fossa_vulnerability_block_on }} severity vulnerabilities detected in container image."
          echo "Review the FOSSA dashboard for details and remediate vulnerabilities."
          exit 1

      - name: Log Emergency Bypass
        if: inputs.skip_fossa_gate
        run: |
          echo "‚ö†Ô∏è EMERGENCY BYPASS USED"
          echo "Justification: ${{ inputs.bypass_justification }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Build Notification
        if: failure()
        uses: SolaceDev/maas-build-actions/.github/actions/build-finish-notifier@master
        with:
          workflow_title: "${{ github.event.repository.name }} Container Scan"
          run_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          notify_channel: ${{ steps.config.outputs.slack_channel }}

# ---
# Usage Notes:
#
# This shareable workflow performs FOSSA-based container image scanning with:
# - Automatic context detection (PR vs Release vs Manual)
# - Licensing policy enforcement (configurable BLOCK/REPORT)
# - Vulnerability reporting (configurable BLOCK/REPORT)
# - Emergency bypass capability for outages
# - Flexible secret management (Vault or GitHub Secrets)
#
# Secret Management:
# - Default: GitHub Secrets (use_vault: false) - for public repos
# - Optional: Vault (use_vault: true) - for private repos with Vault access
#
# Context Detection:
# - PR: Diff-based scan (only new issues), branch=PR, revision=<image_tag>
# - Non-PR: Full scan, branch=default_branch, revision=<image_tag>
#
# Gates:
# - Licensing: Configurable (BLOCK or REPORT) on policy conflicts
# - Vulnerabilities: Configurable (BLOCK or REPORT) on critical/high CVEs
# - Emergency bypass available via workflow_dispatch/orchestrator
#
# Example usage in PUBLIC repos (GitHub Secrets):
#
# PR Scanning:
#   container_scan:
#     uses: SolaceDev/solace-public-workflows/.github/workflows/container-scan-and-guard.yaml@main
#     secrets:
#       FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
#     with:
#       container_image: ghcr.io/solacedev/my-app:${{ github.sha }}
#
# Release Scanning:
#   container_scan:
#     uses: SolaceDev/solace-public-workflows/.github/workflows/container-scan-and-guard.yaml@main
#     secrets:
#       FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
#     with:
#       container_image: ghcr.io/solacedev/my-app:${{ needs.version_bump.outputs.version }}
#
# Example usage in PRIVATE repos (Vault):
#
# Release Scanning with Vault:
#   container_scan:
#     uses: SolaceDev/maas-build-actions/.github/workflows/container-scan-and-guard.yaml@master
#     with:
#       container_image: 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-app:${{ needs.version_bump.outputs.version }}
#       use_vault: true
#       vault_url: "https://vault.maas-vault-prod.solace.cloud:8200"
#
# With Emergency Bypass:
#   container_scan:
#     uses: SolaceDev/solace-public-workflows/.github/workflows/container-scan-and-guard.yaml@main
#     secrets:
#       FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
#     with:
#       container_image: ghcr.io/solacedev/my-app:v1.0.0
#       skip_fossa_gate: true
#       bypass_justification: "FOSSA service outage - INC12345"
#
# Blocking on Vulnerabilities:
#   container_scan:
#     uses: SolaceDev/solace-public-workflows/.github/workflows/container-scan-and-guard.yaml@main
#     secrets:
#       FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
#     with:
#       container_image: ghcr.io/solacedev/my-app:v1.0.0
#       fossa_vulnerability_mode: "BLOCK"
#       fossa_vulnerability_block_on: "critical,high"
# ---
