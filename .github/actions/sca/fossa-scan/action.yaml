name: "Fossa Scan"
description: "Runs a Fossa scan using FOSSA_API_KEY and SCA_FOSSA_* env vars."

inputs: {}
runs:
  using: "composite"
  steps:
    - name: Fossa - Preparation step
      shell: bash
      run: |
        echo "::group::‚öôÔ∏è Fossa Preparation"
        echo "Installing FOSSA CLI..."
        curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash

        SCA_FOSSA_ADDITIONAL_ARGS=""

        #if SCA_FOSSA_ANALYZE_DEBUG is set to true, add --debug to analyze args
        if [ "${{ env.SCA_FOSSA_ANALYZE_DEBUG }}" == "true" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --debug"
        fi

        # Set branch parameter if SCA_FOSSA_BRANCH environment variable is provided
        if [ -n "${{ env.SCA_FOSSA_BRANCH }}" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --branch ${{ env.SCA_FOSSA_BRANCH }}"
        fi

        # Set revision parameter if SCA_FOSSA_REVISION environment variable is provided
        if [ -n "${{ env.SCA_FOSSA_REVISION }}" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --revision ${{ env.SCA_FOSSA_REVISION }}"
        fi

        # Add --unpack-archives if SCA_FOSSA_UNPACK_ARCHIVES is set to true
        if [ "${{ env.SCA_FOSSA_UNPACK_ARCHIVES }}" == "true" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --unpack-archives"
        fi

        # Add --without-default-filters if SCA_FOSSA_WITHOUT_DEFAULT_FILTERS is set to true
        if [ "${{ env.SCA_FOSSA_WITHOUT_DEFAULT_FILTERS }}" == "true" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --without-default-filters"
        fi

        # Add --force-vendored-dependency-rescans if SCA_FOSSA_FORCE_VENDORED_DEPENDENCY_RESCANS is set to true
        if [ "${{ env.SCA_FOSSA_FORCE_VENDORED_DEPENDENCY_RESCANS }}" == "true" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --force-vendored-dependency-rescans"
        fi

        # Add --path if SCA_FOSSA_PATH is provided
        if [ -n "${{ env.SCA_FOSSA_PATH }}" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --path ${{ env.SCA_FOSSA_PATH }}"
          echo "Using FOSSA path: ${{ env.SCA_FOSSA_PATH }}"
        fi

        # Add --config if SCA_FOSSA_CONFIG is provided
        if [ -n "${{ env.SCA_FOSSA_CONFIG }}" ]; then
          SCA_FOSSA_ADDITIONAL_ARGS="$SCA_FOSSA_ADDITIONAL_ARGS --config ${{ env.SCA_FOSSA_CONFIG }}"
          echo "Using FOSSA config: ${{ env.SCA_FOSSA_CONFIG }}"
        fi

        echo "SCA_FOSSA_ADDITIONAL_ARGS=${SCA_FOSSA_ADDITIONAL_ARGS}" >> "$GITHUB_ENV"

        # Set up test args with only revision parameter
        SCA_FOSSA_TEST_ARGS=""
        if [ -n "${{ env.SCA_FOSSA_REVISION }}" ]; then
          SCA_FOSSA_TEST_ARGS="--revision ${{ env.SCA_FOSSA_REVISION }}"
        fi
        echo "SCA_FOSSA_TEST_ARGS=${SCA_FOSSA_TEST_ARGS}" >> "$GITHUB_ENV"

        echo "::endgroup::"

    - name: Fossa - Scan
      shell: bash
      run: |
        echo "::group::üîç Fossa Scan"
        FOSSA_CMD="fossa analyze"

        echo "Running: $FOSSA_CMD $SCA_FOSSA_ADDITIONAL_ARGS"
        $FOSSA_CMD $SCA_FOSSA_ADDITIONAL_ARGS
        echo "::endgroup::"

    - name: FOSSA - Scan Wait For Results
      continue-on-error: true
      shell: bash
      run: |
        echo "::group::‚è≥ Fossa Wait For Results"
        echo "Running: fossa test $SCA_FOSSA_TEST_ARGS"
        fossa test $SCA_FOSSA_TEST_ARGS
        echo "::endgroup::"
